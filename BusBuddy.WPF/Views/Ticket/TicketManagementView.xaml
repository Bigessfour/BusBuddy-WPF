<UserControl x:Class="BusBuddy.WPF.Views.Ticket.TicketManagementView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:viewModels="clr-namespace:BusBuddy.WPF.ViewModels"
             xmlns:converters="clr-namespace:BusBuddy.WPF.Converters"
             mc:Ignorable="d"
             d:DesignHeight="800" d:DesignWidth="1200">
    
    <!-- Global converters used from App.xaml -->
    
    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Placeholder message overlay -->
        <Border Background="#80FFFFFF" Margin="-10" Visibility="{Binding IsInDevelopment, Converter={StaticResource BooleanToVisibilityConverter}, FallbackValue=Visible}">
            <TextBlock Text="Ticket Management - In Development"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       FontSize="16"
                       Foreground="Gray"/>
        </Border>
        
        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0 0 0 10">
            <TextBlock Text="Ticket Management" FontSize="24" FontWeight="Bold"/>
            <TextBlock Text="Create, view, and manage transportation tickets" Foreground="Gray"/>
        </StackPanel>
        
        <!-- Filters and Stats -->
        <Grid Grid.Row="1" Margin="0 0 0 10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            
            <!-- Filters -->
            <Border Grid.Column="0" BorderBrush="#E0E0E0" BorderThickness="1" CornerRadius="5" Padding="10">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <TextBlock Grid.Row="0" Grid.ColumnSpan="5" Text="Filter Tickets" FontWeight="SemiBold" Margin="0 0 0 5"/>
                    
                    <StackPanel Grid.Row="1" Grid.Column="0" Margin="0 0 5 0">
                        <TextBlock Text="Search" Margin="0 0 0 3"/>
                        <TextBox Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" Padding="5"/>
                    </StackPanel>
                    
                    <StackPanel Grid.Row="1" Grid.Column="1" Margin="5 0 5 0">
                        <TextBlock Text="Status" Margin="0 0 0 3"/>
                        <ComboBox ItemsSource="{Binding StatusFilters}" SelectedItem="{Binding SelectedStatus}" Padding="5"/>
                    </StackPanel>
                    
                    <StackPanel Grid.Row="1" Grid.Column="2" Margin="5 0 5 0">
                        <TextBlock Text="Ticket Type" Margin="0 0 0 3"/>
                        <ComboBox ItemsSource="{Binding TicketTypeFilters}" SelectedItem="{Binding SelectedTicketType}" Padding="5"/>
                    </StackPanel>
                    
                    <StackPanel Grid.Row="1" Grid.Column="3" Margin="5 0 5 0">
                        <TextBlock Text="Date Range" Margin="0 0 0 3"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <DatePicker Grid.Column="0" SelectedDate="{Binding FromDate}" Padding="5"/>
                            <TextBlock Grid.Column="1" Text="to" VerticalAlignment="Center" Margin="5 0"/>
                            <DatePicker Grid.Column="2" SelectedDate="{Binding ToDate}" Padding="5"/>
                        </Grid>
                    </StackPanel>
                    
                    <StackPanel Grid.Row="1" Grid.Column="4" Margin="5 0 0 0" VerticalAlignment="Bottom">
                        <Button Content="Apply" Command="{Binding ApplyFiltersCommand}" Padding="10 5" Margin="0 0 0 5"/>
                        <Button Content="Reset" Command="{Binding ResetFiltersCommand}" Padding="10 5"/>
                    </StackPanel>
                </Grid>
            </Border>
            
            <!-- Stats -->
            <Border Grid.Column="1" BorderBrush="#E0E0E0" BorderThickness="1" CornerRadius="5" Padding="10" Margin="10 0 0 0" Width="250">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <TextBlock Grid.Row="0" Text="Statistics" FontWeight="SemiBold" Margin="0 0 0 5"/>
                    
                    <StackPanel Grid.Row="1">
                        <TextBlock Text="Ticket Counts" FontWeight="SemiBold" Margin="0 5 0 2"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            
                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Total Tickets"/>
                            <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding CountStats[TotalTickets]}"/>
                            
                            <TextBlock Grid.Row="1" Grid.Column="0" Text="Valid Tickets"/>
                            <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding CountStats[ValidTickets]}"/>
                            
                            <TextBlock Grid.Row="2" Grid.Column="0" Text="Used Tickets"/>
                            <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding CountStats[UsedTickets]}"/>
                            
                            <TextBlock Grid.Row="3" Grid.Column="0" Text="Cancelled/Expired"/>
                            <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding CountStats[CancelledTickets]}"/>
                        </Grid>
                    </StackPanel>
                    
                    <StackPanel Grid.Row="2">
                        <TextBlock Text="Revenue Stats" FontWeight="SemiBold" Margin="0 10 0 2"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            
                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Today"/>
                            <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding RevenueStats[TodayRevenue], StringFormat=${0:N2}}"/>
                            
                            <TextBlock Grid.Row="1" Grid.Column="0" Text="This Week"/>
                            <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding RevenueStats[WeekRevenue], StringFormat=${0:N2}}"/>
                            
                            <TextBlock Grid.Row="2" Grid.Column="0" Text="This Month"/>
                            <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding RevenueStats[MonthRevenue], StringFormat=${0:N2}}"/>
                        </Grid>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>
        
        <!-- Ticket List and Details -->
        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="350"/>
            </Grid.ColumnDefinitions>
            
            <!-- Ticket List -->
            <Border Grid.Column="0" BorderBrush="#E0E0E0" BorderThickness="1" CornerRadius="5">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <DockPanel Grid.Row="0" Margin="10 10 10 5">
                        <TextBlock Text="Ticket List" FontWeight="SemiBold" DockPanel.Dock="Left" VerticalAlignment="Center"/>
                        <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" HorizontalAlignment="Right">
                            <Button Content="Refresh" Command="{Binding RefreshCommand}" Padding="8 3" Margin="0 0 5 0"/>
                            <Button Content="Export CSV" Command="{Binding ExportToCsvCommand}" Padding="8 3"/>
                        </StackPanel>
                    </DockPanel>
                    
                    <DataGrid Grid.Row="1" ItemsSource="{Binding TicketsView}" 
                              SelectedItem="{Binding SelectedTicket}"
                              AutoGenerateColumns="False"
                              IsReadOnly="True"
                              SelectionMode="Single"
                              SelectionUnit="FullRow"
                              GridLinesVisibility="Horizontal"
                              BorderThickness="0"
                              Margin="0 5 0 0">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="ID" Binding="{Binding TicketId}" Width="50"/>
                            <DataGridTextColumn Header="Student" Binding="{Binding Student.FullName}" Width="150"/>
                            <DataGridTextColumn Header="Route" Binding="{Binding Route.RouteName}" Width="150"/>
                            <DataGridTextColumn Header="Travel Date" Binding="{Binding TravelDate, StringFormat=MM/dd/yyyy}" Width="100"/>
                            <DataGridTextColumn Header="Type" Binding="{Binding TicketType}" Width="100"/>
                            <DataGridTextColumn Header="Price" Binding="{Binding Price, StringFormat=${0:N2}}" Width="70"/>
                            <DataGridTextColumn Header="Status" Binding="{Binding Status}" Width="80"/>
                            <DataGridTextColumn Header="QR Code" Binding="{Binding QRCode}" Width="120"/>
                            <DataGridTextColumn Header="Issue Date" Binding="{Binding IssuedDate, StringFormat=MM/dd/yyyy HH:mm}" Width="130"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </Border>
            
            <GridSplitter Grid.Column="1" Width="5" HorizontalAlignment="Center" VerticalAlignment="Stretch"/>
            
            <!-- Ticket Details and Edit -->
            <Border Grid.Column="2" BorderBrush="#E0E0E0" BorderThickness="1" CornerRadius="5">
                <TabControl>
                    <!-- Edit Selected Ticket Tab -->
                    <TabItem Header="Edit Ticket">
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <StackPanel Margin="10">
                                <TextBlock Text="Edit Selected Ticket" FontWeight="SemiBold" Margin="0 0 0 10"/>

                                <TextBlock Text="Student" Margin="0 5 0 2"/>
                                <ComboBox ItemsSource="{Binding Students}" 
                                          SelectedItem="{Binding SelectedStudent}"
                                          SelectedValuePath="StudentId"
                                          DisplayMemberPath="FullName"
                                          IsEnabled="{Binding SelectedTicket, Converter={StaticResource NullToBoolConverter}}"/>

                                <TextBlock Text="Route" Margin="0 5 0 2"/>
                                <ComboBox ItemsSource="{Binding Routes}" 
                                          SelectedItem="{Binding SelectedRoute}"
                                          SelectedValuePath="RouteId"
                                          DisplayMemberPath="RouteName"
                                          IsEnabled="{Binding SelectedTicket, Converter={StaticResource NullToBoolConverter}}"/>

                                <TextBlock Text="Travel Date" Margin="0 5 0 2"/>
                                <DatePicker SelectedDate="{Binding SelectedTicket.TravelDate}"
                                           IsEnabled="{Binding SelectedTicket, Converter={StaticResource NullToBoolConverter}}"/>

                                <TextBlock Text="Ticket Type" Margin="0 5 0 2"/>
                                <ComboBox ItemsSource="{Binding TicketTypes}" 
                                          SelectedItem="{Binding SelectedTicket.TicketType}"
                                          IsEnabled="{Binding SelectedTicket, Converter={StaticResource NullToBoolConverter}}"/>

                                <TextBlock Text="Price" Margin="0 5 0 2"/>
                                <TextBox Text="{Binding SelectedTicket.Price}" 
                                         IsEnabled="{Binding SelectedTicket, Converter={StaticResource NullToBoolConverter}}"/>

                                <TextBlock Text="Payment Method" Margin="0 5 0 2"/>
                                <ComboBox ItemsSource="{Binding PaymentMethods}" 
                                          SelectedItem="{Binding SelectedTicket.PaymentMethod}"
                                          IsEnabled="{Binding SelectedTicket, Converter={StaticResource NullToBoolConverter}}"/>

                                <TextBlock Text="Status" Margin="0 5 0 2"/>
                                <ComboBox ItemsSource="{Binding TicketStatuses}" 
                                          SelectedItem="{Binding SelectedTicket.Status}"
                                          IsEnabled="{Binding SelectedTicket, Converter={StaticResource NullToBoolConverter}}"/>

                                <TextBlock Text="Notes" Margin="0 5 0 2"/>
                                <TextBox Text="{Binding SelectedTicket.Notes}" 
                                         TextWrapping="Wrap"
                                         AcceptsReturn="True"
                                         Height="60"
                                         IsEnabled="{Binding SelectedTicket, Converter={StaticResource NullToBoolConverter}}"/>

                                <TextBlock Text="QR Code" Margin="0 5 0 2"/>
                                <TextBox Text="{Binding SelectedTicket.QRCode}" IsReadOnly="True" 
                                         IsEnabled="{Binding SelectedTicket, Converter={StaticResource NullToBoolConverter}}"/>

                                <StackPanel Orientation="Horizontal" Margin="0 15 0 0">
                                    <Button Content="Update Ticket" Command="{Binding UpdateTicketCommand}" 
                                            Padding="10 5" Margin="0 0 5 0"
                                            IsEnabled="{Binding SelectedTicket, Converter={StaticResource NullToBoolConverter}}"/>
                                    <Button Content="Cancel Ticket" Command="{Binding CancelTicketCommand}" 
                                            Padding="10 5" Margin="5 0"
                                            IsEnabled="{Binding SelectedTicket, Converter={StaticResource NullToBoolConverter}}"/>
                                    <Button Content="Mark as Used" Command="{Binding UseTicketCommand}" 
                                            Padding="10 5" Margin="5 0"
                                            IsEnabled="{Binding SelectedTicket, Converter={StaticResource NullToBoolConverter}}"/>
                                </StackPanel>
                                
                                <StackPanel Orientation="Horizontal" Margin="0 5 0 0">
                                    <Button Content="Generate QR Code" Command="{Binding GenerateQrCodeCommand}" 
                                            Padding="10 5" Margin="0 0 5 0"
                                            IsEnabled="{Binding SelectedTicket, Converter={StaticResource NullToBoolConverter}}"/>
                                    <Button Content="Delete Ticket" Command="{Binding DeleteTicketCommand}" 
                                            Padding="10 5" Margin="5 0" Foreground="Red"
                                            IsEnabled="{Binding SelectedTicket, Converter={StaticResource NullToBoolConverter}}"/>
                                </StackPanel>
                            </StackPanel>
                        </ScrollViewer>
                    </TabItem>
                    
                    <!-- Create New Ticket Tab -->
                    <TabItem Header="Create New Ticket">
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <StackPanel Margin="10">
                                <TextBlock Text="Create New Ticket" FontWeight="SemiBold" Margin="0 0 0 10"/>

                                <TextBlock Text="Student" Margin="0 5 0 2"/>
                                <ComboBox ItemsSource="{Binding Students}" 
                                          SelectedValue="{Binding NewTicket.StudentId}"
                                          SelectedValuePath="StudentId"
                                          DisplayMemberPath="FullName"/>

                                <TextBlock Text="Route" Margin="0 5 0 2"/>
                                <ComboBox ItemsSource="{Binding Routes}" 
                                          SelectedValue="{Binding NewTicket.RouteId}"
                                          SelectedValuePath="RouteId"
                                          DisplayMemberPath="RouteName"/>

                                <TextBlock Text="Travel Date" Margin="0 5 0 2"/>
                                <DatePicker SelectedDate="{Binding NewTicket.TravelDate}"/>

                                <TextBlock Text="Ticket Type" Margin="0 5 0 2"/>
                                <ComboBox ItemsSource="{Binding TicketTypes}" 
                                          SelectedItem="{Binding NewTicket.TicketType}"/>

                                <TextBlock Text="Price" Margin="0 5 0 2"/>
                                <TextBox Text="{Binding NewTicket.Price}"/>

                                <TextBlock Text="Payment Method" Margin="0 5 0 2"/>
                                <ComboBox ItemsSource="{Binding PaymentMethods}" 
                                          SelectedItem="{Binding NewTicket.PaymentMethod}"/>

                                <TextBlock Text="Notes" Margin="0 5 0 2"/>
                                <TextBox Text="{Binding NewTicket.Notes}" 
                                         TextWrapping="Wrap"
                                         AcceptsReturn="True"
                                         Height="60"/>

                                <Button Content="Create Ticket" Command="{Binding CreateTicketCommand}" 
                                        Padding="10 5" Margin="0 15 0 0" HorizontalAlignment="Left"/>
                            </StackPanel>
                        </ScrollViewer>
                    </TabItem>
                </TabControl>
            </Border>
        </Grid>
        
        <!-- Footer -->
        <Border Grid.Row="3" BorderBrush="#E0E0E0" BorderThickness="1" CornerRadius="5" Padding="10" Margin="0 10 0 0">
            <StackPanel>
                <TextBlock Text="Ticket Management System" FontWeight="SemiBold"/>
                <TextBlock Text="Create and manage transportation tickets for students. Filter tickets, track revenue, and manage ticket lifecycle." FontStyle="Italic"/>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>
